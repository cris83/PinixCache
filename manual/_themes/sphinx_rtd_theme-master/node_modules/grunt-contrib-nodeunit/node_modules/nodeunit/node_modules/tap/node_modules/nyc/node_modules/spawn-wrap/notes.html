

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>&lt;no title&gt; &mdash; PINIX Cache Docs 1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../../../../../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PINIX Cache Docs 1.0 documentation" href="../../../../../../../../../../../../index.html"/> 

  
  <script src="../../../../../../../../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../../../../../../../../index.html" class="icon icon-home"> PINIX Cache Docs
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../../Global.html">Global</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../../Origin.html">Origin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../../VHost.html">VHost</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../../../../../../../VHost-Proxy.html">Virtual Host Proxy</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../../../../../../../../index.html">PINIX Cache Docs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../../../../../../../../index.html">Docs</a> &raquo;</li>
      
    <li>&lt;no title&gt;</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../../../../../../../../../_sources/_themes/sphinx_rtd_theme-master/node_modules/grunt-contrib-nodeunit/node_modules/nodeunit/node_modules/tap/node_modules/nyc/node_modules/spawn-wrap/notes.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>New approach:</p>
<ul>
<li><p class="first"><cite>spawn(&#8216;sh&#8217;, ...)</cite></p>
<blockquote>
<div><p>Find the <cite>-c</cite> arg.</p>
<p>Parse, and split up by <cite>&amp;&amp;</cite>, <cite>||</cite>, <cite>;</cite>, <cite>&amp;</cite>, and <cite>|</cite>, expanding
each bit.</p>
<p>The parsing doesn&#8217;t have to be complete, since it&#8217;s not designed
for security.  Just handling quotes and escapes is probably
enough.  If someone sneaks in a <cite>$VAR</cite> that expands to a node
shebang, oh well.  If we DO want to make it work for security use
cases, then it would perhaps be good to be able to detect these
situations and throw an error or something.</p>
<p>Then spawn the exploded command line.  When we explode it, we need
to do the same thing with looking up env and shebang results.
However, if there are multiple parts, we can&#8217;t change the actual
thing that gets executed (ie, it must still be executed by calling
<cite>sh</cite>, just with the exploded command line).</p>
<p><cite>cmd</cite> is basically the same, but the escapes are different, and
we&#8217;re looking for the <cite>/c</cite> argument rather than <cite>-c</cite>.  In the
short term, probably we should just explicitly not support
windows, by printing a warning and doing nothing if run in
Windows.  This may be a case where explicit non-support is better
than poor or partial support.</p>
<p>Each portion of the sh command line looks like:</p>
<p><cite>(key=val )*(command)( args)*</cite></p>
</div></blockquote>
</li>
<li><p class="first"><cite>spawn(&#8216;.../node&#8217;, ...)</cite></p>
<blockquote>
<div><p>Inject the args before the main, if it has a main file, and call
spawn with that.</p>
</div></blockquote>
</li>
<li><p class="first"><cite>spawn(&#8216;other&#8217;, ...)</cite></p>
<blockquote>
<div><p>Check if it&#8217;s a shebang file.  If so, explode it to the resulting
cli: <cite>$interpreter $file</cite>.  In most cases, this will result in
<cite>env &lt;envpairs&gt; node &lt;nodeoptions&gt; $file</cite></p>
<p>Note that a shebang is strictly space-delimited arguments.  Quotes
and escapes are not allowed here, which makes it much simpler.  We
can simply resolve this to <cite>shebangLine.trim().split(/s+/)</cite>.  If
that first item is <cite>env</cite> then handle it just like a <cite>spawn(env)</cite>.</p>
</div></blockquote>
</li>
<li><p class="first"><cite>spawn(&#8216;env&#8217;, ...)</cite></p>
<blockquote>
<div><p>An env command line is done by looking up the resulting thingy
with <cite>which()</cite>, and then resolving it further if it&#8217;s a shebangK</p>
</div></blockquote>
</li>
<li><p class="first">Always treat <cite>bash</cite>, <cite>ksh</cite>, and <cite>zsh</cite> the same as <cite>sh</cite>, since they
have similar cli string behavior.</p>
</li>
</ul>
<hr class="docutils" />
<p>Different ways to spawn things:</p>
<ol class="arabic simple">
<li><cite>spawn(&#8216;node&#8217;, ...)</cite></li>
</ol>
<blockquote>
<div>easiest.
inject the args, add the envPairs</div></blockquote>
<ol class="arabic simple" start="2">
<li><cite>spawn(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;X=y /path/to/node blah&#8217;])</cite></li>
</ol>
<blockquote>
<div><p>Parse &#8216;-c&#8217; arg just like a exec line.
Windows flavor: <cite>spawn(&#8216;cmd&#8217;, [&#8216;/s&#8217;, &#8216;/c&#8217;, &#8216;&#8221;&#8217; + command + &#8216;&#8221;&#8217;])</cite></p>
<p>replace <cite>(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;/path/to/node &lt;inject args&gt; blah&#8217;])</cite>
I think if we do this right, we don&#8217;t have to do exec() maybe?</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><cite>spawn(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;/usr/bin/env x=y node blah blah&#8217;])</cite></li>
</ol>
<blockquote>
<div><p>This is the hard one, because the indirection capabilities are
endless.  <cite>sh</cite> can spawn <cite>bash</cite> which spawns <cite>env</cite> and so on.</p>
<ol class="upperalpha simple">
<li>replace with <cite>spawn(&#8216;/usr/bin/env&#8217;, [&#8216;x=y&#8217;, &#8216;node&#8217;, &#8216;...&#8217;])</cite></li>
</ol>
<blockquote>
<div>WARNING: requires writing a sh-compatible command line parser.
Splitting based on spaces won&#8217;t work.
Eg: <cite>sh -c &#8216;command &#8220;long       space&#8221;&#8217;</cite></div></blockquote>
<ol class="upperalpha simple" start="2">
<li>Write a node program that wraps cli commands, sort of like the</li>
</ol>
<blockquote>
<div>wrap-main.js file.  This will let us the just prepend it to the
<cite>sh -c</cite> arg, and it can interpret the rest.</div></blockquote>
<p>C. Maybe we just have our own <cite>node</cite> and <cite>iojs</cite> scripts (and
<cite>node.cmd</cite> and <cite>iojs.cmd</cite> for win32 peops), and we put those in a
bin folder that we always prepend to the PATH environ.  Then it
almost doesn&#8217;t <em>matter</em> what shebangs or whatever get run, because
<cite>which node</cite> will always return that thing.  Something to consider.
(Also, that fakey <cite>node</cite> script cannot be a node program, obviously,
because the shell won&#8217;t know where to find it!)
<strong>OOPS!</strong> no that won&#8217;t work because how does the fake node shell
script know what to inject to our wrap-main.js file?
Computers are terrible.</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><cite>spawn(&#8216;shebangscript&#8217;, [&#8216;arg&#8217;])</cite></li>
</ol>
<blockquote>
<div>resolve shebangscript using which()
read first line of script
<cite>#!/some/interpreter some=args</cite> -&gt;
<cite>spawn(&#8216;/some/interpreter&#8217;, [&#8216;some=args&#8217;, &#8216;$file&#8217;])</cite>
then handle appropriately</div></blockquote>
<ol class="arabic simple" start="5">
<li><cite>spawn(&#8216;/usr/bin/env&#8217;, [&#8216;x=y&#8217;, &#8216;node&#8217;, &#8216;$file&#8217;])</cite></li>
</ol>
<blockquote>
<div>becomes case (1), <cite>spawn(&#8216;node&#8217;, [&#8216;$file&#8217;)</cite>, but with the <cite>x=y</cite>
appended to the envPairs list</div></blockquote>
<ol class="arabic simple" start="6">
<li><cite>spawn(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;shebangscript arg&#8217;])</cite></li>
<li><cite>exec(&#8216;/path/to/node blah blah&#8217;)</cite></li>
</ol>
<blockquote>
<div>becomes <cite>spawn(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;/path/to/node blah blah&#8217;])</cite></div></blockquote>
<ol class="arabic simple" start="8">
<li><cite>exec(&#8216;/usr/bin/env node blah blah&#8217;)</cite></li>
</ol>
<blockquote>
<div>becomes <cite>spawn(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;/usr/bin/env node blah blah&#8217;])</cite></div></blockquote>
<ol class="arabic simple" start="9">
<li><cite>exec(&#8216;sh -c &#8220;shebangscript arg&#8221;&#8217;)</cite></li>
</ol>
<blockquote>
<div>becomes <cite>spawn(&#8216;sh&#8217;, [&#8216;-c&#8217;, &#8216;sh -c &#8220;shebangscript arg&#8221;&#8217;])</cite>
This is a dark pit of oblivion.</div></blockquote>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Â© NFLabs. All rights reserved..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../../../../../../../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../../../../../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../../../../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../../../../../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../../../../../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>